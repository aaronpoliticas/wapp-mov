<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAPP - MOV | Finanzas</title>
    
    <!-- 1. Tailwind CSS para los estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Babel para traducir React en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Estilos para animaciones simples -->
    <style>
        .cursor-wait { cursor: wait; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <!-- 3. Tu Aplicación React -->
    <script type="text/babel" data-type="module">
        // Importamos React y Lucide desde un CDN moderno (esm.sh)
        import React, { useState, useEffect } from 'https://esm.sh/react@18?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18/client?dev';
        import { Upload, FileDown, Trash2, CheckCircle, AlertCircle, FileText, Cloud, CloudOff, Loader2, Info } from 'https://esm.sh/lucide-react@0.263.1?dev';

        // URL de producción de tu Google Apps Script
        const API_URL = "https://script.google.com/macros/s/AKfycbwoLFhMe3lBT9YUBceM8MasNCoEif1ykmR7VmGh02knV32JheqTEisfUAksJghQ63oNHw/exec";

        const App = () => {
            const [processedRows, setProcessedRows] = useState([]);
            const [lastSavedSignature, setLastSavedSignature] = useState(null);
            const [lastSavedDate, setLastSavedDate] = useState(null);
            const [statusMessage, setStatusMessage] = useState(null);
            const [fileName, setFileName] = useState("");
            const [isSyncing, setIsSyncing] = useState(false);

            // --- 1. CARGA INICIAL (Sincronización GET) ---
            useEffect(() => {
                fetchLastMovement();
            }, []);

            const fetchLastMovement = async () => {
                setIsSyncing(true);
                try {
                const response = await fetch(API_URL);
                const text = await response.text();
                
                let data = null;
                try {
                    if (text && text.trim() !== "") {
                        data = JSON.parse(text);
                    }
                } catch (e) {
                    console.warn("Respuesta no JSON (celda vacía o sucia):", text);
                }
                
                if (data && data.fecha) {
                    setLastSavedSignature(data);
                    setLastSavedDate(data.fecha);
                    console.log("Sincronizado desde nube:", data);
                } else {
                    console.log("Sin datos previos en nube.");
                }
                } catch (error) {
                console.error("Error GET:", error);
                setStatusMessage({ type: 'warning', text: 'Sin conexión a Google Sheets. Modo local.' });
                } finally {
                setIsSyncing(false);
                }
            };

            // --- 2. GUARDADO EN NUBE (Sincronización POST) ---
            const saveToCloud = async (movement) => {
                setIsSyncing(true);
                try {
                const payload = JSON.stringify({ 
                    ultimoMovimiento: movement ? JSON.stringify(movement) : "" 
                });

                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: payload
                });
                
                if (movement) {
                    setLastSavedSignature(movement);
                    setLastSavedDate(movement.fecha);
                } else {
                    setLastSavedSignature(null);
                    setLastSavedDate(null);
                }
                } catch (error) {
                console.error("Error POST:", error);
                setStatusMessage({ type: 'error', text: 'Error al guardar en la nube.' });
                } finally {
                setIsSyncing(false);
                }
            };

            const clearMemory = async () => {
                setProcessedRows([]);
                setFileName("");
                setStatusMessage({ type: 'info', text: 'Borrando memoria en la nube...' });
                await saveToCloud(null);
                setStatusMessage({ type: 'info', text: 'Memoria reiniciada.' });
            };

            // --- 3. PROCESAMIENTO DE ARCHIVO ---
            const parseCurrency = (str) => {
                if (!str) return 0;
                const cleanStr = str.replace(/,/g, '').trim();
                const num = parseFloat(cleanStr);
                return isNaN(num) ? 0 : num;
            };

            const getMonthYear = (dateStr) => {
                if (!dateStr) return '';
                const parts = dateStr.split('/');
                if (parts.length < 3) return '';
                return `${parts[1]}/${parts[2]}`; // MM/YYYY
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setFileName(file.name);
                const reader = new FileReader();
                reader.onload = (e) => processFileContent(e.target.result);
                reader.readAsText(file);
                event.target.value = ''; 
            };

            const processFileContent = (text) => {
                const lines = text.split('\n');
                const newRows = [];
                
                const startIndex = lines[0].toLowerCase().includes('concepto') ? 1 : 0;

                for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const columns = line.split('\t');
                if (columns.length < 2) continue;

                const fecha = columns[0].trim();
                const descripcion = columns[1].trim();
                const cargoStr = columns[2] ? columns[2].trim() : "";
                const abonoStr = columns[3] ? columns[3].trim() : "";

                const cargo = parseCurrency(cargoStr);
                const abono = parseCurrency(abonoStr);
                const importe = abono - cargo;

                newRows.push({
                    fecha,
                    descripcion,
                    importe: importe,
                    rawSignature: `${fecha}-${descripcion}-${importe}`
                });
                }

                if (newRows.length === 0) {
                setStatusMessage({ type: 'error', text: 'Archivo inválido o vacío.' });
                return;
                }

                // --- LÓGICA DE DEDUPLICACIÓN ---
                const currentFileFirstDate = newRows[0].fecha;
                const currentMonth = getMonthYear(currentFileFirstDate);
                const lastSavedMonth = getMonthYear(lastSavedDate);

                let finalRows = [];
                let isNewMonth = false;

                // Caso A: Cambio de mes explícito
                if (lastSavedDate && currentMonth !== lastSavedMonth) {
                isNewMonth = true;
                setStatusMessage({ type: 'info', text: `Cambio de mes (${currentMonth}). Se procesó información de un mes nuevo.` });
                finalRows = newRows;
                } 
                // Caso B: Tenemos memoria (posiblemente del mismo mes)
                else if (lastSavedSignature) {
                const cutOffIndex = newRows.findIndex(row => row.rawSignature === lastSavedSignature.rawSignature);

                if (cutOffIndex === -1) {
                    finalRows = newRows;
                    setStatusMessage({ type: 'info', text: 'Se procesó información de un mes nuevo.' });
                } else if (cutOffIndex === 0) {
                    finalRows = [];
                    setStatusMessage({ type: 'success', text: '¡Todo al día! No hay movimientos nuevos.' });
                } else {
                    finalRows = newRows.slice(0, cutOffIndex);
                    setStatusMessage({ type: 'success', text: `Se encontraron ${finalRows.length} movimientos nuevos.` });
                }
                } 
                // Caso C: Memoria vacía (Primera vez)
                else {
                finalRows = newRows;
                setStatusMessage({ type: 'success', text: `Archivo procesado. ${newRows.length} movimientos listos.` });
                }

                setProcessedRows(finalRows);

                if (newRows.length > 0) {
                const newestMovement = newRows[0];
                if (isNewMonth || !lastSavedSignature || newestMovement.rawSignature !== lastSavedSignature.rawSignature) {
                    saveToCloud(newestMovement);
                }
                }
            };

            const downloadCSV = () => {
                if (processedRows.length === 0) return;

                const headers = ['FECHA', 'DESCRIPCION', 'IMPORTE'];
                const csvContent = [
                headers.join(','),
                ...processedRows.map(row => {
                    const descSafe = `"${row.descripcion.replace(/"/g, '""')}"`; 
                    return `${row.fecha},${descSafe},${row.importe.toFixed(2)}`;
                })
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `movimientos_procesados_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="min-h-screen bg-gray-50 p-8 font-sans text-gray-800">
                <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
                    
                    {/* Header */}
                    <div className="bg-blue-600 p-6 text-white flex justify-between items-center">
                    <div>
                        <h1 className="text-2xl font-bold flex items-center gap-2">
                        <FileText className="w-6 h-6" /> WAPP - MOV
                        </h1>
                        <p className="text-blue-100 text-sm mt-1">Procesador de extractos con memoria en la nube</p>
                    </div>
                    
                    <div className="flex items-center gap-3">
                        {isSyncing && (
                            <div className="flex items-center gap-1 text-xs bg-blue-700/50 px-2 py-1 rounded animate-pulse">
                                <Loader2 className="w-3 h-3 animate-spin" />
                                Sync...
                            </div>
                        )}
                        
                        {lastSavedDate ? (
                        <div className="text-right text-xs bg-blue-700 p-2 rounded-lg flex items-center gap-2">
                            <div>
                                <p className="opacity-75">Último procesado:</p>
                                <p className="font-mono font-bold">{lastSavedDate}</p>
                            </div>
                            <Cloud className="w-5 h-5 text-blue-200" />
                        </div>
                        ) : (
                        !isSyncing && <div className="text-xs bg-blue-700 p-2 rounded-lg flex items-center gap-2 opacity-75">
                            <span>Sin datos</span>
                            <CloudOff className="w-5 h-5" />
                        </div>
                        )}
                    </div>
                    </div>

                    {/* Main Content */}
                    <div className="p-8 space-y-8">
                    
                    {/* Status Messages */}
                    {statusMessage && (
                        <div className={`p-4 rounded-lg flex items-start gap-3 ${
                        statusMessage.type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' :
                        statusMessage.type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' :
                        statusMessage.type === 'warning' ? 'bg-yellow-50 text-yellow-700 border border-yellow-200' :
                        'bg-blue-50 text-blue-700 border border-blue-200'
                        }`}>
                        {statusMessage.type === 'success' && <CheckCircle className="w-5 h-5 mt-0.5" />}
                        {statusMessage.type === 'error' && <AlertCircle className="w-5 h-5 mt-0.5" />}
                        {statusMessage.type === 'warning' && <AlertCircle className="w-5 h-5 mt-0.5" />}
                        {statusMessage.type === 'info' && <Info className="w-5 h-5 mt-0.5" />}
                        
                        <div>
                            <p className="font-medium">{statusMessage.text}</p>
                        </div>
                        </div>
                    )}

                    {/* Upload Area */}
                    <div className={`border-2 border-dashed rounded-xl p-8 text-center transition-colors relative group ${isSyncing ? 'border-gray-200 bg-gray-50 cursor-wait' : 'border-gray-300 hover:bg-gray-50'}`}>
                        <input 
                        type="file" 
                        accept=".txt,.csv,.tsv" 
                        onChange={handleFileUpload}
                        disabled={isSyncing}
                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer disabled:cursor-not-allowed"
                        />
                        <div className={`flex flex-col items-center gap-3 ${isSyncing ? 'opacity-50' : ''}`}>
                        <div className="bg-blue-100 p-4 rounded-full text-blue-600 group-hover:scale-110 transition-transform">
                            <Upload className="w-8 h-8" />
                        </div>
                        <div>
                            <p className="text-lg font-medium text-gray-700">
                            {fileName ? fileName : "Arrastra tu archivo MOV aquí"}
                            </p>
                            <p className="text-sm text-gray-400 mt-1">
                                {isSyncing ? "Sincronizando..." : "o haz clic para buscarlo"}
                            </p>
                        </div>
                        </div>
                    </div>

                    {/* Preview & Actions */}
                    {processedRows.length > 0 ? (
                        <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div className="flex justify-between items-center">
                            <h3 className="font-bold text-gray-700">Vista Previa ({processedRows.length} nuevos)</h3>
                            <button 
                            onClick={downloadCSV}
                            className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2 shadow-sm transition-all hover:shadow-md active:scale-95"
                            >
                            <FileDown className="w-5 h-5" />
                            Descargar CSV
                            </button>
                        </div>

                        <div className="border border-gray-200 rounded-lg overflow-hidden max-h-64 overflow-y-auto shadow-inner bg-gray-50">
                            <table className="w-full text-sm text-left">
                            <thead className="bg-gray-100 text-gray-600 font-semibold sticky top-0">
                                <tr>
                                <th className="p-3 border-b">FECHA</th>
                                <th className="p-3 border-b">DESCRIPCION</th>
                                <th className="p-3 border-b text-right">IMPORTE</th>
                                </tr>
                            </thead>
                            <tbody>
                                {processedRows.map((row, idx) => (
                                <tr key={idx} className="border-b last:border-0 hover:bg-white">
                                    <td className="p-3 text-gray-600 whitespace-nowrap">{row.fecha}</td>
                                    <td className="p-3 text-gray-800 max-w-xs truncate" title={row.descripcion}>{row.descripcion}</td>
                                    <td className={`p-3 text-right font-mono font-medium ${row.importe < 0 ? 'text-red-600' : 'text-blue-600'}`}>
                                    {row.importe.toLocaleString('es-MX', { minimumFractionDigits: 2 })}
                                    </td>
                                </tr>
                                ))}
                            </tbody>
                            </table>
                        </div>
                        </div>
                    ) : (
                        fileName && processedRows.length === 0 && statusMessage?.type !== 'error' && (
                            <div className="text-center py-4 text-gray-600 font-bold">
                            El archivo se leyó pero no hay movimientos nuevos que reportar.
                            </div>
                        )
                    )}

                    {/* Footer / Reset Memory */}
                    <div className="pt-6 border-t border-gray-100 flex justify-between items-center text-sm text-gray-500">
                        <p className="flex items-center gap-2">
                            <Cloud className="w-4 h-4" />
                            Sincronizado con Google Sheets
                        </p>
                        {(lastSavedDate) && (
                        <button 
                            onClick={clearMemory}
                            disabled={isSyncing}
                            className="flex items-center gap-1 text-red-400 hover:text-red-600 transition-colors disabled:opacity-50"
                            title="Borrar memoria en la nube"
                        >
                            {isSyncing ? <Loader2 className="w-4 h-4 animate-spin" /> : <Trash2 className="w-4 h-4" />}
                            Reiniciar memoria
                        </button>
                        )}
                    </div>

                    </div>
                </div>
                </div>
            );
        };

        // Renderizado
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
