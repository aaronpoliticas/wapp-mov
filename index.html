<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSC | Conversor MOV BBVA</title>
    
    <!-- 1. Tailwind CSS para los estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Babel para traducir React en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Estilos para animaciones simples -->
    <style>
        .cursor-wait { cursor: wait; }
    </style>
</head>
<body class="bg-[#F3F4F6] min-h-screen flex items-center justify-center py-10 px-4 font-sans">
    <div id="root" class="w-full max-w-3xl"></div>

    <!-- 3. Tu Aplicación React -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18/client?dev';
        import { Upload, FileDown, Trash2, CheckCircle, AlertCircle, FileText, Cloud, CloudOff, Loader2, Info, Settings, AlertTriangle, X, ClipboardList, Globe, Database, ShieldCheck, Filter, ListOrdered } from 'https://esm.sh/lucide-react@0.263.1?dev';

        const API_URL = "https://script.google.com/macros/s/AKfycbwoLFhMe3lBT9YUBceM8MasNCoEif1ykmR7VmGh02knV32JheqTEisfUAksJghQ63oNHw/exec";

        // --- DICCIONARIO DE TRADUCCIONES ---
        const TRANSLATIONS = {
            es: {
                title: "Conversor MOV",
                subtitlePre: "Preparación de archivos ",
                subtitleUnderline: "MOV BBVA",
                subtitlePost: " para importación en Odoo.",
                syncing: "Sinc...",
                lastProcessed: "Último procesado:",
                noData: "Sin datos",
                settingsTitle: "CONFIGURACIÓN",
                memStatus: "Memoria Actual:",
                restartMemory: "Reiniciar memoria",
                uploadTitle: "Arrastra tu archivo MOV aquí",
                uploadSubtitle: "o haz clic para buscarlo",
                chooseFileBtn: "Elegir Archivo",
                previewTitle: "Vista Previa",
                newItems: "nuevos",
                downloadBtn: "Descargar CSV para Odoo",
                footerText: "SSC GOURMET DISTRIBUTION 2026",
                
                // Mensajes de estado
                msgErrorFile: "Archivo inválido o vacío.",
                msgMonthChange: "Cambio de mes detectado. Se procesó información de un mes nuevo.",
                msgNewMonthGeneric: "Se procesó información de un mes nuevo.",
                msgUpToDate: "¡Todo al día! No hay movimientos nuevos.",
                msgNewFound: (count) => `Se encontraron ${count} movimientos nuevos.`,
                msgProcessed: (count) => `Archivo procesado. ${count} movimientos listos.`,
                msgNoNewReport: "El archivo se leyó pero no hay movimientos nuevos que reportar.",
                msgWarningDup: "Corte exacto no encontrado. Se filtraron automáticamente fechas anteriores.",
                msgMethodExact: "Corte Exacto (Ordenado)",
                msgMethodDate: "Filtrado por Fecha (Seguridad)",
                
                // Modal Borrar
                modalTitle: "¿Estás segur@ de borrar la memoria?",
                modalText1: "Tendrás que revisar que después de borrarla,",
                modalTextBold: "no dupliques los registros en Odoo",
                modalText2: ". Esta acción no se puede deshacer.",
                btnCancel: "Cancelar",
                btnConfirm: "Sí, borrar memoria",
                msgDeleting: "Borrando memoria en la nube...",
                msgDeleted: "Memoria reiniciada exitosamente.",
                msgSaveError: "Error al guardar en la nube.",

                // Instrucciones
                instrTitle: "Instrucciones de Uso",
                step1: "Descarga los movimientos de la banca BBVA en formato .txt del día",
                step2: "Arrastra el archivo a la sección de carga marcada arriba",
                step3: "Si no hay errores aparecerá un botón morado para descargar el archivo .csv",
                step4: "Abre Odoo entra a Contabilidad y arrastra el archivo al cuadro de la cuenta:",
                step5part1: "En la ventana emergente oprime",
                step5btn1: "\"Probar\"",
                step5part2: "Si aparece la leyenda",
                step5msg: "\"Todo parece correcto\"",
                step5part3: "oprime",
                step5btn2: "\"Importar\"",
                langLabel: "LENGUAJE / LANGUE"
            },
            fr: {
                title: "Convertisseur MOV",
                subtitlePre: "Préparation des fichiers ",
                subtitleUnderline: "MOV BBVA",
                subtitlePost: " pour l'importation dans Odoo.",
                syncing: "Sync...",
                lastProcessed: "Dernier traité :",
                noData: "Aucune donnée",
                settingsTitle: "PARAMÈTRES",
                memStatus: "Mémoire Actuelle :",
                restartMemory: "Réinitialiser la mémoire",
                uploadTitle: "Glissez votre fichier MOV ici",
                uploadSubtitle: "ou cliquez pour parcourir",
                chooseFileBtn: "Choisir le fichier",
                previewTitle: "Aperçu",
                newItems: "nouveaux",
                downloadBtn: "Télécharger CSV pour Odoo",
                footerText: "SSC GOURMET DISTRIBUTION 2026",
                
                // Mensajes de estado
                msgErrorFile: "Fichier invalide ou vide.",
                msgMonthChange: "Changement de mois détecté. Traitement du nouveau mois.",
                msgNewMonthGeneric: "Informations d'un nouveau mois traitées.",
                msgUpToDate: "Tout est à jour ! Aucun nouveau mouvement.",
                msgNewFound: (count) => `${count} nouveaux mouvements trouvés.`,
                msgProcessed: (count) => `Fichier traité. ${count} mouvements prêts.`,
                msgNoNewReport: "Le fichier a été lu mais il n'y a aucun nouveau mouvement à signaler.",
                msgWarningDup: "Point d'arrêt exact non trouvé. Filtre strict par date appliqué.",
                msgMethodExact: "Point d'arrêt exact trouvé",
                msgMethodDate: "Filtré par Date (Sécurité)",

                // Modal Borrar
                modalTitle: "Êtes-vous sûr de vouloir effacer la mémoire ?",
                modalText1: "Vous devrez vérifier qu'après l'effacement,",
                modalTextBold: "vous ne dupliquez pas les enregistrements dans Odoo",
                modalText2: ". Cette action est irréversible.",
                btnCancel: "Annuler",
                btnConfirm: "Oui, effacer la mémoire",
                msgDeleting: "Effacement de la mémoire dans le cloud...",
                msgDeleted: "Mémoire réinitialisée avec succès.",
                msgSaveError: "Erreur lors de l'enregistrement dans le cloud.",

                // Instrucciones
                instrTitle: "Instructions d'Utilisation",
                step1: "Téléchargez les mouvements bancaires BBVA au format .txt du jour",
                step2: "Glissez le fichier dans la zone de chargement indiquée ci-dessus",
                step3: "S'il n'y a pas d'erreur un bouton violet apparaîtra pour télécharger le fichier .csv",
                step4: "Ouvrez Odoo allez dans Comptabilité et glissez le fichier dans le cadre du compte :",
                step5part1: "Dans la fenêtre contextuelle cliquez sur",
                step5btn1: "\"Probar\"",
                step5part2: "Si le message",
                step5msg: "\"Todo parece correcto\"",
                step5part3: "apparaît cliquez sur",
                step5btn2: "\"Importar\"",
                langLabel: "LENGUAJE / LANGUE"
            }
        };

        const App = () => {
            const [processedRows, setProcessedRows] = useState([]);
            const [lastSavedSignature, setLastSavedSignature] = useState(null);
            const [lastSavedDate, setLastSavedDate] = useState(null);
            const [statusMessage, setStatusMessage] = useState(null);
            const [processingMethod, setProcessingMethod] = useState(null); 
            const [fileName, setFileName] = useState("");
            const [isSyncing, setIsSyncing] = useState(false);
            
            const [language, setLanguage] = useState('es');
            const t = TRANSLATIONS[language];

            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const settingsRef = useRef(null);

            useEffect(() => {
                fetchLastMovement();
                const handleClickOutside = (event) => {
                    if (settingsRef.current && !settingsRef.current.contains(event.target)) {
                        setIsSettingsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const fetchLastMovement = async () => {
                setIsSyncing(true);
                try {
                    const response = await fetch(API_URL);
                    const text = await response.text();
                    let data = null;
                    try {
                        if (text && text.trim() !== "") {
                            data = JSON.parse(text);
                        }
                    } catch (e) {
                        console.warn("Respuesta no JSON:", text);
                    }
                    
                    if (data && data.fecha) {
                        setLastSavedSignature(data);
                        setLastSavedDate(data.fecha);
                    }
                } catch (error) {
                    setStatusMessage({ type: 'warning', text: 'Sin conexión a Google Sheets. Modo local.' });
                } finally {
                    setIsSyncing(false);
                }
            };

            const saveToCloud = async (movement) => {
                setIsSyncing(true);
                try {
                    const payload = JSON.stringify({ 
                        ultimoMovimiento: movement ? JSON.stringify(movement) : "" 
                    });

                    await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: payload
                    });
                    
                    if (movement) {
                        setLastSavedSignature(movement);
                        setLastSavedDate(movement.fecha);
                    } else {
                        setLastSavedSignature(null);
                        setLastSavedDate(null);
                    }
                } catch (error) {
                    setStatusMessage({ type: 'error', text: t.msgSaveError });
                } finally {
                    setIsSyncing(false);
                }
            };

            const clearMemory = async () => {
                setShowDeleteConfirm(false);
                setIsSettingsOpen(false);
                setProcessedRows([]);
                setFileName("");
                setProcessingMethod(null);
                setStatusMessage({ type: 'info', text: t.msgDeleting });
                await saveToCloud(null);
                setStatusMessage({ type: 'info', text: t.msgDeleted });
            };

            const parseCurrency = (str) => {
                if (!str) return 0;
                const cleanStr = str.replace(/,/g, '').trim();
                const num = parseFloat(cleanStr);
                return isNaN(num) ? 0 : num;
            };

            const getDateValue = (dateStr) => {
                if (!dateStr) return 0;
                const cleanDate = dateStr.trim().replace(/-/g, '/');
                const parts = cleanDate.split('/');
                if (parts.length < 3) return 0;
                // YYYYMMDD para comparación entera
                return parseInt(`${parts[2]}${parts[1].padStart(2,'0')}${parts[0].padStart(2,'0')}`);
            };

            const parseDate = (dateStr) => {
                if (!dateStr) return new Date(0);
                const cleanDate = dateStr.trim().replace(/-/g, '/');
                const parts = cleanDate.split('/');
                if (parts.length < 3) return new Date(0);
                return new Date(parts[2], parts[1] - 1, parts[0]);
            };

            const formatDateForOdoo = (dateStr) => {
                const parts = dateStr.split(/[\/\-]/);
                if (parts.length < 3) return dateStr; 
                return `${parts[1]}-${parts[0]}-${parts[2]}`;
            };

            const getMonthYear = (dateStr) => {
                if (!dateStr) return '';
                const parts = dateStr.split(/[\/\-]/); 
                if (parts.length < 3) return '';
                return `${parts[1]}/${parts[2]}`; 
            };

            const normalizeText = (text) => {
                if (!text) return "";
                return text
                    .toUpperCase()
                    .replace(/[ÁÉÍÓÚ]/g, (c) => ({'Á':'A','É':'E','Í':'I','Ó':'O','Ú':'U'}[c])) 
                    .replace(/[^A-Z0-9]/g, ''); 
            };

            const isSameRow = (rowA, rowB) => {
                if (!rowA || !rowB) return false;
                const valA = getDateValue(rowA.fecha);
                const valB = getDateValue(rowB.fecha);
                const descA = normalizeText(rowA.descripcion);
                const descB = normalizeText(rowB.descripcion);
                const impA = parseFloat(rowA.importe);
                const impB = parseFloat(rowB.importe);
                const isImporteSame = Math.abs(impA - impB) < 0.01;
                return valA === valB && descA === descB && isImporteSame;
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setFileName(file.name);
                const reader = new FileReader();
                reader.onload = (e) => processFileContent(e.target.result);
                reader.readAsText(file);
                event.target.value = ''; 
            };

            const processFileContent = (text) => {
                const currentT = TRANSLATIONS[language]; 
                setProcessingMethod(null);

                const lines = text.split('\n');
                let newRows = [];
                const startIndex = lines[0].toLowerCase().includes('concepto') ? 1 : 0;

                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const columns = line.split('\t');
                    if (columns.length < 2) continue;

                    const fecha = columns[0].trim();
                    const descripcion = columns[1].trim();
                    const cargoStr = columns[2] ? columns[2].trim() : "";
                    const abonoStr = columns[3] ? columns[3].trim() : "";
                    const cargo = parseCurrency(cargoStr);
                    const abono = parseCurrency(abonoStr);
                    const importe = abono - cargo;

                    newRows.push({
                        fecha,
                        descripcion,
                        importe: importe,
                        rawSignature: `${fecha}-${normalizeText(descripcion)}-${importe.toFixed(2)}`
                    });
                }

                if (newRows.length === 0) {
                    setStatusMessage({ type: 'error', text: currentT.msgErrorFile });
                    return;
                }

                // --- 1. ORDENAMIENTO ESTÁNDAR: ANTIGUO A RECIENTE ---
                // Para tener una línea de tiempo coherente, ordenamos todo por fecha
                // Si las fechas son iguales, usamos la descripción para mantener un orden determinista
                newRows.sort((a, b) => {
                    const dateA = getDateValue(a.fecha);
                    const dateB = getDateValue(b.fecha);
                    if (dateA !== dateB) return dateA - dateB; // Antiguo primero
                    
                    // Desempate por importe
                    const impDiff = a.importe - b.importe;
                    if (Math.abs(impDiff) > 0.01) return impDiff;

                    // Desempate por descripción
                    return a.descripcion.localeCompare(b.descripcion);
                });

                const currentFileLastDate = newRows[newRows.length - 1].fecha; // Fecha más reciente (al final)
                const currentMonth = getMonthYear(currentFileLastDate);
                const lastSavedMonth = getMonthYear(lastSavedDate);

                let finalRows = [];
                let isNewMonth = false;

                if (lastSavedDate && currentMonth !== lastSavedMonth) {
                    isNewMonth = true;
                    setStatusMessage({ type: 'info', text: currentT.msgMonthChange });
                    finalRows = newRows;
                } 
                else if (lastSavedSignature) {
                    // --- 2. BÚSQUEDA DEL CORTE EN LA LISTA ORDENADA ---
                    // Buscamos la ULTIMA aparición del registro guardado
                    // (Por si hubiera duplicados idénticos en días anteriores, queremos el último procesado)
                    let cutOffIndex = -1;
                    for (let i = newRows.length - 1; i >= 0; i--) {
                        if (isSameRow(newRows[i], lastSavedSignature)) {
                            cutOffIndex = i;
                            break;
                        }
                    }

                    if (cutOffIndex !== -1) {
                        setProcessingMethod('exact');
                        // Tomamos todo lo que sigue después del corte
                        finalRows = newRows.slice(cutOffIndex + 1);
                        
                        if (finalRows.length === 0) {
                            setStatusMessage({ type: 'success', text: currentT.msgUpToDate });
                        } else {
                            setStatusMessage({ type: 'success', text: currentT.msgNewFound(finalRows.length) });
                        }
                    } else {
                        // --- 3. FALLBACK: FILTRO POR FECHA ---
                        setProcessingMethod('date');
                        const savedDateVal = getDateValue(lastSavedDate);
                        
                        finalRows = newRows.filter(row => {
                            const rowDateVal = getDateValue(row.fecha);
                            return rowDateVal > savedDateVal;
                        });

                        if (finalRows.length === 0) {
                             setStatusMessage({ type: 'success', text: currentT.msgUpToDate });
                        } else {
                             setStatusMessage({ type: 'warning', text: currentT.msgWarningDup });
                        }
                    }
                } 
                else {
                    // Primera vez
                    finalRows = newRows;
                    setStatusMessage({ type: 'success', text: currentT.msgProcessed(newRows.length) });
                }

                // La lista 'finalRows' ya viene ordenada (Antiguo -> Reciente) porque 'newRows' se ordenó al inicio.
                setProcessedRows(finalRows);

                // --- 4. GUARDAR MEMORIA ---
                // Guardamos el ÚLTIMO elemento de la lista ordenada COMPLETA (newRows)
                // ya que ese es el movimiento más reciente en el tiempo que hemos visto hoy.
                if (newRows.length > 0) {
                    const newestMovement = newRows[newRows.length - 1]; 
                    
                    if (isNewMonth || !lastSavedSignature || !isSameRow(newestMovement, lastSavedSignature)) {
                        saveToCloud(newestMovement);
                    }
                }
            };

            const downloadCSV = () => {
                if (processedRows.length === 0) return;
                const headers = ['FECHA', 'DESCRIPCION', 'IMPORTE'];
                const csvContent = [
                    headers.join(','),
                    ...processedRows.map(row => {
                        const descSafe = `"${row.descripcion.replace(/"/g, '""')}"`; 
                        const fechaFormateada = formatDateForOdoo(row.fecha);
                        return `${fechaFormateada},${descSafe},${row.importe.toFixed(2)}`;
                    })
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `movimientos_procesados_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="bg-white rounded-3xl shadow-2xl overflow-hidden w-full relative">
                    
                    {/* Header */}
                    <div className="bg-white p-8 pb-2 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h1 className="text-4xl font-bold text-[#1e293b] tracking-tight" style={{ fontFamily: "'Century Gothic', Futura, sans-serif" }}>
                                {t.title}
                            </h1>
                            <p className="text-gray-500 text-sm mt-2">
                                {t.subtitlePre}
                                <span className="underline decoration-1 underline-offset-2 decoration-gray-400">{t.subtitleUnderline}</span>
                                {t.subtitlePost}
                            </p>
                        </div>
                        
                        <div>
                            {isSyncing ? (
                                <div className="bg-gray-100 text-gray-500 rounded-xl px-4 py-2 flex items-center gap-2 text-xs font-medium animate-pulse">
                                    <Loader2 className="w-3 h-3 animate-spin" />
                                    {t.syncing}
                                </div>
                            ) : (
                                <div className={`rounded-xl px-4 py-2 flex items-center gap-2 text-xs font-medium ${lastSavedDate ? 'bg-[#9CA3AF] text-white' : 'bg-gray-100 text-gray-400'}`}>
                                    {lastSavedDate ? (
                                        <>
                                            <span className="opacity-90">{t.lastProcessed}</span>
                                            <span className="font-mono font-bold">{lastSavedDate}</span>
                                            <Cloud className="w-4 h-4 ml-1" />
                                        </>
                                    ) : (
                                        <>
                                            <span>{t.noData}</span>
                                            <CloudOff className="w-4 h-4" />
                                        </>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="p-8 space-y-6">
                    
                        {/* Status Messages */}
                        {statusMessage && (
                            <div className={`p-4 rounded-xl flex items-start gap-3 border ${
                            statusMessage.type === 'error' ? 'bg-red-50 text-red-700 border-red-100' :
                            statusMessage.type === 'success' ? 'bg-green-50 text-green-700 border-green-100' :
                            statusMessage.type === 'warning' ? 'bg-yellow-50 text-yellow-700 border-yellow-100' :
                            'bg-blue-50 text-blue-700 border-blue-100'
                            }`}>
                            {statusMessage.type === 'success' && <CheckCircle className="w-5 h-5 mt-0.5" />}
                            {statusMessage.type === 'error' && <AlertCircle className="w-5 h-5 mt-0.5" />}
                            {statusMessage.type === 'warning' && <AlertCircle className="w-5 h-5 mt-0.5" />}
                            {statusMessage.type === 'info' && <Info className="w-5 h-5 mt-0.5" />}
                            
                            <div>
                                <p className="font-medium text-sm">{statusMessage.text}</p>
                            </div>
                            </div>
                        )}

                        {/* Upload Area */}
                        <div className={`border-2 border-dashed rounded-2xl p-10 text-center transition-all duration-300 relative group ${
                            isSyncing ? 'border-gray-200 bg-gray-50 cursor-wait' : 'border-gray-300 hover:border-blue-400 hover:bg-blue-50/30'
                        }`}>
                            <input 
                            type="file" 
                            accept=".txt,.csv,.tsv" 
                            onChange={handleFileUpload}
                            disabled={isSyncing}
                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer disabled:cursor-not-allowed z-10"
                            />
                            <div className={`flex flex-col items-center gap-4 ${isSyncing ? 'opacity-50' : ''}`}>
                                <div className="bg-white p-4 rounded-2xl shadow-sm text-gray-700 group-hover:scale-110 transition-transform border border-gray-100">
                                    <Upload className="w-8 h-8" />
                                </div>
                                <div>
                                    <p className="text-xl font-semibold text-gray-800">
                                        {fileName ? fileName : t.uploadTitle}
                                    </p>
                                    <p className="text-gray-400 mt-2 font-medium">
                                        {isSyncing ? t.syncing : t.uploadSubtitle}
                                    </p>
                                </div>
                                {!fileName && !isSyncing && (
                                    <button className="mt-2 bg-[#0F172A] text-white px-6 py-2 rounded-lg text-sm font-medium opacity-90 group-hover:opacity-100 transition-opacity">
                                        {t.chooseFileBtn}
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Preview & Actions */}
                        {processedRows.length > 0 ? (
                            <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                            
                            {/* Método de procesamiento visual */}
                            {processingMethod && (
                                <div className={`flex items-center gap-2 text-[10px] uppercase font-bold tracking-wider mb-2 px-1 ${
                                    processingMethod === 'exact' ? 'text-green-600' : 'text-yellow-600'
                                }`}>
                                    {processingMethod === 'exact' ? <ShieldCheck className="w-4 h-4" /> : <Filter className="w-4 h-4" />}
                                    {processingMethod === 'exact' ? t.msgMethodExact : t.msgMethodDate}
                                </div>
                            )}

                            <div className="flex justify-between items-center px-1">
                                <h3 className="font-bold text-gray-700">{t.previewTitle} <span className="text-gray-400 font-normal">({processedRows.length} {t.newItems})</span></h3>
                                <button 
                                onClick={downloadCSV}
                                disabled={isSyncing}
                                className={`bg-[#714B67] text-white px-6 py-2.5 rounded-xl font-medium flex items-center gap-2 shadow-lg shadow-purple-900/10 transition-all ${
                                    isSyncing 
                                    ? 'opacity-70 cursor-wait' 
                                    : 'hover:bg-[#5a3b52] hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:scale-95'
                                }`}
                                >
                                {isSyncing ? <Loader2 className="w-5 h-5 animate-spin" /> : <FileDown className="w-5 h-5" />}
                                {t.downloadBtn}
                                </button>
                            </div>

                            <div className="border border-gray-200 rounded-xl overflow-hidden max-h-64 overflow-y-auto shadow-inner bg-gray-50/50">
                                <table className="w-full text-sm text-left">
                                <thead className="bg-gray-100 text-gray-600 font-semibold sticky top-0">
                                    <tr>
                                    <th className="p-3 border-b">FECHA</th>
                                    <th className="p-3 border-b">DESCRIPCION</th>
                                    <th className="p-3 border-b text-right">IMPORTE</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {processedRows.map((row, idx) => (
                                    <tr key={idx} className="border-b last:border-0 hover:bg-white transition-colors">
                                        <td className="p-3 text-gray-600 whitespace-nowrap">{row.fecha}</td>
                                        <td className="p-3 text-gray-800 max-w-xs truncate" title={row.descripcion}>{row.descripcion}</td>
                                        <td className={`p-3 text-right font-mono font-medium ${row.importe < 0 ? 'text-red-600' : 'text-blue-600'}`}>
                                        {row.importe.toLocaleString('es-MX', { minimumFractionDigits: 2 })}
                                        </td>
                                    </tr>
                                    ))}
                                </tbody>
                                </table>
                            </div>
                            </div>
                        ) : (
                            fileName && processedRows.length === 0 && statusMessage?.type !== 'error' && (
                                <div className="text-center py-6 text-gray-500 font-medium bg-gray-50 rounded-xl border border-dashed border-gray-200">
                                    {t.msgNoNewReport}
                                </div>
                            )
                        )}

                        {/* SECCIÓN DE INSTRUCCIONES + SELECTOR DE IDIOMA */}
                        <div className="bg-[#F8F9FA] border border-gray-100 rounded-2xl p-8 relative mt-8">
                            
                            <div className="flex flex-col md:flex-row md:items-center justify-between border-b border-gray-200 pb-4 mb-4 gap-4">
                                <h3 className="font-bold text-gray-800 flex items-center gap-2 text-lg">
                                    <ClipboardList className="w-5 h-5 text-gray-600" />
                                    {t.instrTitle}
                                </h3>

                                <div className="flex items-center gap-2">
                                    <span className="text-[10px] uppercase font-bold text-gray-400 tracking-wider flex items-center gap-1">
                                        <Globe className="w-3 h-3" />
                                        {t.langLabel}
                                    </span>
                                    <div className="flex bg-white border border-gray-200 rounded-lg p-1 shadow-sm">
                                        <button 
                                            onClick={() => setLanguage('es')} 
                                            className={`px-3 py-1 rounded-md text-xs font-semibold transition-all ${
                                                language === 'es' 
                                                ? 'bg-gray-100 text-gray-900 shadow-sm' 
                                                : 'text-gray-400 hover:text-gray-600'
                                            }`}
                                        >
                                            MX Español
                                        </button>
                                        <button 
                                            onClick={() => setLanguage('fr')} 
                                            className={`px-3 py-1 rounded-md text-xs font-semibold transition-all ${
                                                language === 'fr' 
                                                ? 'bg-gray-100 text-gray-900 shadow-sm' 
                                                : 'text-gray-400 hover:text-gray-600'
                                            }`}
                                        >
                                            FR Français
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <ol className="space-y-4 text-sm text-gray-600 list-decimal list-outside ml-4 marker:text-gray-900 marker:font-bold">
                                <li className="pl-2">
                                    {t.step1} <span className="font-mono bg-white border border-gray-300 px-1.5 py-0.5 rounded text-xs text-gray-600 font-bold shadow-sm">.txt</span>
                                </li>
                                <li className="pl-2">
                                    {t.step2}
                                </li>
                                <li className="pl-2">
                                    {t.step3} <span className="font-mono bg-white border border-gray-300 px-1.5 py-0.5 rounded text-xs text-[#714B67] font-bold shadow-sm">.csv</span>
                                </li>
                                <li className="pl-2">
                                    {t.step4}
                                    <div className="mt-2 inline-block bg-[#F3E8FF] border border-purple-200 text-purple-900 px-3 py-1.5 rounded-md font-mono text-xs font-bold shadow-sm">
                                        BBVA - 012180001206755710
                                    </div>
                                </li>
                                <li className="pl-2">
                                    {t.step5part1} <span className="font-bold text-purple-700">{t.step5btn1}</span> {t.step5part2} <em className="text-gray-800">{t.step5msg}</em> {t.step5part3} <span className="font-bold text-purple-700">{t.step5btn2}</span>
                                </li>
                            </ol>
                        </div>

                    </div>

                    {/* Footer + Settings */}
                    <div className="p-6 border-t border-gray-50 flex items-center justify-center relative bg-white">
                        <p className="text-[10px] uppercase font-bold tracking-widest text-gray-400">
                            {t.footerText}
                        </p>
                        
                        {/* Botón de Ajustes */}
                        <div className="absolute right-6 bottom-4" ref={settingsRef}>
                            <button 
                                onClick={() => setIsSettingsOpen(!isSettingsOpen)}
                                className="p-2 bg-[#9CA3AF] hover:bg-gray-600 rounded-lg transition-colors text-white shadow-md hover:shadow-lg"
                                title={t.settingsTitle}
                            >
                                <Settings className="w-5 h-5" />
                            </button>
                            
                            {isSettingsOpen && (
                                <div className="absolute bottom-full right-0 mb-2 w-64 bg-white rounded-xl shadow-2xl border border-gray-100 overflow-hidden z-20 animate-in fade-in slide-in-from-bottom-2 duration-200">
                                    <div className="p-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                        <p className="text-xs font-semibold text-gray-500 uppercase">{t.settingsTitle}</p>
                                    </div>
                                    
                                    {/* Muestra Visual de la Memoria */}
                                    {lastSavedSignature && (
                                        <div className="px-4 py-3 border-b border-gray-50 bg-blue-50/50">
                                            <p className="text-[10px] text-gray-400 uppercase font-bold mb-1 flex items-center gap-1">
                                                <Database className="w-3 h-3" /> {t.memStatus}
                                            </p>
                                            <div className="text-xs text-gray-600 font-mono space-y-1">
                                                <p className="truncate" title={lastSavedSignature.fecha}>{lastSavedSignature.fecha}</p>
                                                <p className="truncate font-bold">${lastSavedSignature.importe?.toFixed(2)}</p>
                                            </div>
                                        </div>
                                    )}

                                    <button 
                                        onClick={() => {
                                            if (lastSavedDate) setShowDeleteConfirm(true);
                                            setIsSettingsOpen(false);
                                        }}
                                        disabled={!lastSavedDate || isSyncing}
                                        className="w-full text-left px-4 py-3 text-sm hover:bg-red-50 text-red-600 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
                                    >
                                        <Trash2 className="w-4 h-4" />
                                        {t.restartMemory}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Modal de Confirmación */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-gray-900/30 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden scale-100 animate-in zoom-in-95 duration-200">
                                <div className="p-8 text-center">
                                    <div className="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <AlertTriangle className="w-8 h-8 text-red-500" />
                                    </div>
                                    <h3 className="text-xl font-bold text-gray-900 mb-2">{t.modalTitle}</h3>
                                    <p className="text-gray-500 mb-8 leading-relaxed">
                                        {t.modalText1} <span className="font-bold text-gray-800">{t.modalTextBold}</span>{t.modalText2}
                                    </p>
                                    <div className="flex gap-3 justify-center">
                                        <button 
                                            onClick={() => setShowDeleteConfirm(false)}
                                            className="px-6 py-2.5 rounded-xl border border-gray-200 text-gray-600 font-semibold hover:bg-gray-50 transition-colors"
                                        >
                                            {t.btnCancel}
                                        </button>
                                        <button 
                                            onClick={clearMemory}
                                            className="px-6 py-2.5 rounded-xl bg-red-500 text-white font-semibold hover:bg-red-600 shadow-lg shadow-red-200 transition-all hover:scale-105"
                                        >
                                            {t.btnConfirm}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
